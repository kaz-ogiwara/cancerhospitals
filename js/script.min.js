const DEFAULT_LAT_LNG=[36.679,139.232],DEFAULT_ZOOM=7,CANCERS={1:"その他の悪性腫瘍",2:"ホジキン病",3:"乳房の悪性腫瘍",4:"内分泌腺および関連組織の腫瘍",5:"前立腺の悪性腫瘍",6:"副腎皮質機能亢進症、非機能性副腎皮質腫瘍",7:"卵巣・子宮附属器の悪性腫瘍",8:"外陰の悪性腫瘍",9:"多発性骨髄腫、免疫系悪性新生物",10:"子宮頸・体部の悪性腫瘍",11:"小腸の悪性腫瘍、腹膜の悪性腫瘍",12:"急性白血病",13:"性器の悪性腫瘍",14:"慢性白血病、骨髄増殖性疾患",15:"横隔膜腫瘍・横隔膜疾患（新生児を含む）",16:"甲状腺の悪性腫瘍",17:"皮膚の悪性腫瘍（黒色腫以外）",18:"直腸肛門（直腸Ｓ状部から肛門）の悪性腫瘍",19:"精巣腫瘍",20:"結腸（虫垂を含む）の悪性腫瘍",21:"縦隔悪性腫瘍、縦隔・胸膜の悪性腫瘍",22:"肝・肝内胆管の悪性腫瘍（続発性を含む）",23:"肺の悪性腫瘍",24:"胃の悪性腫瘍",25:"胆嚢、肝外胆管の悪性腫瘍",26:"胸壁腫瘍、胸膜腫瘍",27:"脊椎・脊髄腫瘍",28:"脳腫瘍",29:"腎盂・尿管の悪性腫瘍",30:"腎腫瘍",31:"腟の悪性腫瘍",32:"膀胱腫瘍",33:"膵臓、脾臓の腫瘍",34:"角膜・眼及び付属器の悪性腫瘍",35:"軟部の悪性腫瘍（脊髄を除く）",36:"非ホジキンリンパ腫",37:"頭頸部悪性腫瘍",38:"食道の悪性腫瘍（頸部を含む）",39:"骨の悪性腫瘍（脊椎を除く）",40:"黒色腫"},gIcon=L.icon({iconUrl:"img/material-icon-hospital.svg"}),gIconSelected=L.icon({iconUrl:"img/material-icon-hospital.svg",className:"selected"});let gMap,gValues,gMarkerGroup,gHospitals=[],sHospitals=[],gMarkers=[];const addCommas=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),hideMapCover=()=>{$("#map-cover").removeClass("show")},showMapCover=()=>{$("#map-cover").addClass("show")},showHospital=(t,e)=>{let a;sHospitals.forEach(function(e,s){e[0]===t&&(a=e.slice())}),gotoMap([a[4],a[3]],17),e||gMarkers.forEach(function(t,e){a[4]==t._latlng.lat&&a[3]==t._latlng.lng&&t.openPopup()}),$("#name-area").removeClass("show")},showDetailInfo=t=>{let e;sHospitals.forEach(function(a,s){a[0]===t&&(e=a.slice())}),gMarkers.forEach(function(t,a){e[4]===t._latlng.lat&&e[3]===t._latlng.lng?t.setIcon(gIconSelected):t.setIcon(gIcon)}),$.getJSON("data/info/"+e[0]+".json",function(a){$modal=$("#modal"),$modal.find("h5").text(a[1]),(()=>{const t=(t,e,a)=>{""!==a&&(e=e+"<span>"+a+"</span>"),$("#modal-items").find("tr").eq(t).find("td").html(e)};$items=$("#modal-items"),$items.find("td").text("");let s=e[7].toFixed(1);"NaN"==s&&(s="-"),t(0,a[3]+a[5],""),t(1,a[4],""),t(2,a[2],""),t(3,a[8].replace("-","（拠点指定なし）"),""),t(4,a[9],""),t(5,a[10],""),t(6,addCommas(a[11]),"床"),t(7,addCommas(a[12]),"床"),t(8,addCommas(e[6]),"件"),t(9,s,"日")})(),(()=>{if($area=$("#modal-values-area"),$area.empty(),$modal.find(".notes").text(""),gValues[t]){$area.append('<table id="modal-values"><thead><tr><th>疾患名</th><th class="c">手術</th><th class="c">化学<br />療法等</th><th class="r">診療<br />件数</th><th class="r">平均<br />在院<br />日数</th></tr></thead><tbody></tbody></table>');let e=$("#modal-values");gValues[t].forEach(function(t,a){let s=t[0];if(!e.find("tr.c"+s)[0]){let t='<tr class="c'+s+'"><td class="name" rowspan="4">'+CANCERS[s]+'</td><td class="fg" rowspan="2">あり</td><td class="fg">あり</td><td class="v n1-1">0</td><td class="v d1-1">-</td></tr><tr class="c'+s+'"><td class="fg">なし</td><td class="v n1-2">0</td><td class="v d1-2">-</td></tr><tr class="c'+s+'"><td class="fg" rowspan="2">なし</td><td class="fg">あり</td><td class="v n2-1">0</td><td class="v d2-1">-</td></tr><tr class="c'+s+'"><td class="fg">なし</td><td class="v n2-2">0</td><td class="v d2-2">-</td></tr>';e.find("tbody").append(t)}let o=parseInt(t[3]),n=addCommas((parseFloat(t[4])/o).toFixed(1)),l=e.find("tbody").find("tr.c"+s);l.find("td.n"+t[1]+"-"+t[2]).text(o),l.find("td.d"+t[1]+"-"+t[2]).text(n)}),"12"!==a[13]&&"0"!==a[13]&&$modal.find(".notes").text("診療件数は"+a[13]+"ヶ月間のデータ。比較のため12ヶ月に換算した")}else $modal.find(".notes").text("（がん診療実績データはありません）")})(),$modal.hasClass("show")||$modal.addClass("show")})},gotoMap=(t,e)=>{let a=$("#map-block").offset().top-16;setTimeout(function(){$("html, body").animate({scrollTop:a},600,"swing")},0),gMap.setView(t,e)},searchHospitals=()=>{const t=t=>{let e="";switch(t){case 2:e="国立がん研究センター";break;case 3:e="地域がん診療病院";break;case 4:e="地域がん診療連携拠点病院";break;case 5:e="地域がん診療連携拠点病院（高度型）";break;case 6:e="特定領域がん診療連携拠点病院";break;case 7:e="都道府県がん診療連携拠点病院";break;case 8:e="都道府県独自指定がん拠点病院";break;default:e="（拠点指定なし）"}return e},e=t=>{let e=0;return-1!=="234567".indexOf(t)&&(e=1),-1!=="8".indexOf(t)&&(e=2),e},a=e=>{let a=$("#table-"+e).find("tbody");a.empty();let s=[];sHospitals.forEach(function(t,e){"0"!=t[6]&&s.push(t.slice())}),s.sort(function(t,a){return"num"===e?t[6]<a[6]?1:t[6]==a[6]?0:-1:t[7]>a[7]?1:t[7]==a[7]?0:-1});for(let e=0;e<=9;e++){let o=s[e];o&&a.append('<tr><td><a href="" class="hospital-info" code="'+o[0]+'">'+o[1]+'</a></td><td class="w">'+t(o[5])+'</td><td class="w r">'+addCommas(o[6])+'</td><td class="w r">'+o[7].toFixed(1)+"</td></tr>")}};(()=>{sHospitals=[];let t={prf:$("#select-prf").val(),cbh:$("#select-cbh").val(),mdc:$("#select-mdc").val(),opr:$("#select-opr").val(),trt:$("#select-trt").val()};gHospitals.forEach(function(e,a){let s=!0,o=e.slice(),n={key:e[0].toString(),prf:e[2].toString(),cbh:e[5].toString()};if(""!==t.prf&&t.prf!==n.prf&&(s=!1),""!==t.cbh&&t.cbh!==n.cbh&&(s=!1),""!==t.mdc||""!==t.opr||""!==t.trt){let e=!1;o[6]=0,o[7]=0,gValues[n.key]&&gValues[n.key].forEach(function(a,s){let n={mdc:a[0].toString(),opr:a[1].toString(),trt:a[2].toString()};""!==t.mdc&&t.mdc!==n.mdc||""!==t.opr&&t.opr!==n.opr||""!==t.trt&&t.trt!==n.trt||(o[6]+=Math.round(a[3],1),o[7]+=Math.round(a[4],1),e=!0)}),e||(s=!1)}if(s){let t=o[6],e=o[7],a=Math.round(e/t*100)/100;o[7]=a,sHospitals.push(o)}})})(),showMapCover(),gMarkers&&gMap.removeLayer(gMarkers),gMarkerGroup&&gMap.removeLayer(gMarkerGroup),gMarkerGroup=L.markerClusterGroup(),sHospitals.forEach(function(t,e){let a=t[4],s=t[3];gMarkers[e]=L.marker([a,s],{icon:gIcon}).on("click",function(e){showHospital(t[0],!0)}),gMarkers[e].bindPopup("<h5>"+t[1]+'</h5><p><a class="show-detail" code="'+t[0]+'">詳細情報を表示</a></p>'),gMarkerGroup.addLayer(gMarkers[e])}),gMap.addLayer(gMarkerGroup),hideMapCover(),(()=>{$("#bubble-block").html('<h4>診療件数と平均在院日数の分布</h4><canvas id="bubble-chart"></canvas>');let t={type:"scatter",data:{datasets:[{backgroundColor:"#e98",codes:[],names:[],data:[],label:"厚生労働省の指定病院"},{backgroundColor:"#8b7",codes:[],names:[],data:[],label:"都道府県の指定病院　"},{backgroundColor:"#8ac",codes:[],names:[],data:[],label:"拠点指定なし　　　　"}]},options:{legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(e,a){let s=e[0].datasetIndex,o=e[0].index;return t.data.datasets[s].names[o]},beforeLabel:function(t,e){return"診療件数："+addCommas(t.yLabel)+"件"},label:function(t,e){return"平均在院日数："+addCommas(t.xLabel.toFixed(1))+"日"}}},animation:{animateScale:!0,animateRotate:!0},onClick:function(e,a){if(a&&a.length>=1){let e=a[0]._datasetIndex,s=a[0]._index,o=t.data.datasets[e].codes[s];showHospital(o,!1)}},scales:{yAxes:[{display:!0,scaleLabel:{display:!0,labelString:"診療件数（件）"},ticks:{callback:function(t,e,a){return addCommas(t)}}}],xAxes:[{display:!0,scaleLabel:{display:!0,labelString:"平均在院日数（日）"},ticks:{callback:function(t,e,a){return addCommas(t)}}}]},aspectRatio:1}};sHospitals.forEach(function(a,s){let o=a[5],n=2;1===e(o)&&(n=0),2===e(o)&&(n=1),t.data.datasets[n].data.push({x:a[7],y:a[6]}),t.data.datasets[n].codes.push(a[0]),t.data.datasets[n].names.push(a[1])});let a=$("#bubble-block").width();a>=396&&(t.options.aspectRatio=1.3),a>=477&&(t.options.aspectRatio=1.6);let s=document.getElementById("bubble-chart").getContext("2d");window.myDoughnut=new Chart(s,t)})(),a("num"),a("days")},bindNameEvents=()=>{let t=$("#input-name"),e=$("#name-suggests");t.on("keydown",function(t){if(38===t.keyCode||40===t.keyCode){if(t.preventDefault(),e.find("div")){let a=e.find("div.selected");a&&(a.removeClass("selected"),38===t.which?a.prev()[0]?a.prev().addClass("selected"):e.find("div:last").addClass("selected"):40===t.which&&(a.next()[0]?a.next().addClass("selected"):e.find("div:first").addClass("selected")))}}else if(13===t.keyCode){let t=e.find("div.selected").attr("code");showHospital(t,!1)}}),t.on("keyup focus",function(t){let a=$(this).val();if(a.length>=2){if(38!==t.keyCode&&40!==t.keyCode){e.addClass("show"),e.empty();let t=0;gHospitals.forEach(function(s,o){if(t>=10)return;let n=!1;-1!==s[1].indexOf(a)&&(n=!0),n&&(e.append('<div class="nsi" code="'+s[0]+'">'+s[1]+"</div>"),t++)}),0===t&&e.removeClass("show"),e.find("div:first").addClass("selected")}}else e.removeClass("show")})},bindEvents=()=>{$(document).on("change","select",function(){searchHospitals(),gotoMap(DEFAULT_LAT_LNG,7)}),$(document).on("click","#fullscreen-button",function(t){$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").addClass("fullscreen"),gMap.invalidateSize()).done(function(){$("#cover").fadeOut("fast")})})}),$(document).on("click","#button-close",function(t){t.stopPropagation(),$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").removeClass("fullscreen"),gMap.invalidateSize()).done(function(){$("#cover").fadeOut("fast")})})}),$(document).on("click","a.hospital-info",function(t){t.stopPropagation(),t.preventDefault();let e=$(this).attr("code");showHospital(e,!1)}),$(document).on("click","a.show-detail",function(t){t.stopPropagation(),t.preventDefault();let e=$(this).attr("code");showDetailInfo(e)}),$(document).on("click",".nsi",function(t){t.stopPropagation(),t.preventDefault();let e=$(this).attr("code");showHospital(e,!1)}),$(document).on("mouseover",".nsi",function(t){t.preventDefault(),$(this).siblings().removeClass("selected"),$(this).addClass("selected")}),$(document).on("focus","#input-name",function(t){$("#name-area").addClass("show")}),$(document).on("blur","#input-name",function(t){window.setTimeout(function(){$("#name-area").removeClass("show")},100)}),$(document).on("click","#button-modal-close",function(t){t.stopPropagation(),t.preventDefault(),$("#modal").hasClass("show")&&($("#modal").removeClass("show"),gMarkers.forEach(function(t,e){t.setIcon(gIcon)}))}),$(document).on("click",function(t){$(t.target).closest("#modal").length||$("#modal").hasClass("show")&&($("#modal").removeClass("show"),gMarkers.forEach(function(t,e){t.setIcon(gIcon)}))})},initMap=()=>{gMap=L.map("map").setView(DEFAULT_LAT_LNG,7),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:17,minZoom:5}).addTo(gMap),$.getJSON("data/hospitals.json",function(t){gHospitals=t,$.getJSON("data/values.json",function(t){gValues=t,searchHospitals(),bindNameEvents(),hideMapCover()})})};$(function(){bindEvents(),initMap()});